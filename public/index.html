<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <title>RP Multiplayer - Salas</title>
    <style>
/* VariÃ¡veis de Cores */ /*sinal*/
:root { 
    --bg: #1a1a1a; 
    --card: #2d2d2d; 
    --text: #ffffff; 
    --p1: #ff4d4d; 
    --p2: #2ecc71; 
    --accent: #7048e8; 
    --danger: #e74c3c; 
}

/* Reset BÃ¡sico */
* { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
    font-family: 'Segoe UI', sans-serif; 
}

/* Corpo */
body { 
    background-color: var(--bg); 
    color: var(--text); 
    height: 100vh; 
    overflow: hidden; 
}

/* ----------- TELAS DE LOGIN ----------- */

.full-screen-container { 
    width: 100%; height: 100%;
    display: flex; justify-content: center; align-items: center;
    background-color: var(--bg);
    position: absolute; inset: 0;
    z-index: 10;
}

.auth-box, .room-box { 
    background: var(--card);
    padding: 40px;
    border-radius: 15px;
    width: 90%; max-width: 400px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    border: 1px solid #333;
}

/* ----------- TELA DO JOGO ----------- */

.main-container {
    flex: 1;
    display: flex;
    flex-direction: row;
    height: 100%;
    border-right: 1px solid #333;
}

/* PERSONAGENS (GRID) */
.grid-wrapper {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    justify-content: center;
}

.grid-container { 
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 16px;
    width: 100%;
    max-width: 900px;
}

/* CHAT */
.chat-container {
    display: flex;
    flex-direction: column;
    width: 380px;
    background: #111;
    border-left: 1px solid #333;
    height: 100%;
}

/* Chat interno */
.chat-header {
    padding: 15px;
    background: #1a1a1a;
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid #333;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.chat-input-area {
    padding: 15px;
    background: #1a1a1a;
    display: flex;
    gap: 10px;
    border-top: 1px solid #333;
}

#chatInput {
    flex: 1;
    padding: 12px;
    border-radius: 25px;
    border: 1px solid #444;
    background: #222;
    color: white;
}

/* -------- RESPONSIVIDADE -------- */

/* ðŸ“± MOBILE-FIRST */
@media (max-width: 768px) {

    body {
        overflow: hidden;
    }

    .main-container {
        flex-direction: column;
        width: 100%;
        height: 100%;
    }

    .grid-wrapper {
        padding: 12px;
    }

    /* GRID mais compacto como no mockup */
    .grid-container {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 12px;
        max-width: 100%;
    }

    /* CHAT vira inferior, igual ao exemplo */
    .chat-container {
        width: 100%;
        height: 45vh;
        max-height: 50vh;
        position: relative;
        border-left: none;
        border-top: 1px solid #333;
    }

    .chat-messages {
        padding: 12px;
        height: calc(45vh - 80px);
    }

    .chat-input-area {
        flex-direction: row;
    }

    /* quando o teclado abre, evita que tudo exploda */
    @supports (height: 100dvh) {
        .chat-container {
            height: 45dvh;
        }
        .chat-messages {
            height: calc(45dvh - 80px);
        }
    }
}

/* TABLETS */
@media (min-width: 769px) and (max-width: 1024px) {
    .main-container {
        flex-direction: column;
    }

    .chat-container {
        width: 100%;
        height: 50vh;
    }
}

</style>

</head>
<body>

    <div class="full-screen-container" id="authScreen">
        <div class="auth-box">
            <h2 id="authTitle">Login</h2>
            <div class="error-message" id="authError"></div>

            <input type="text" id="authUsername" placeholder="Nome de UsuÃ¡rio">
            <input type="password" id="authPassword" placeholder="Senha">

            <button class="btn-auth-primary" id="authSubmitBtn" onclick="handleAuth()">Entrar</button>
            
            <div style="margin-top: 15px; font-size: 0.9rem; color: #aaa;">
                <span id="authToggleText">NÃ£o tem uma conta?</span>
                <span id="toggleAuth" onclick="toggleAuthMode()" style="color: var(--accent); cursor: pointer; font-weight: bold; margin-left: 5px;">Cadastrar-se</span>
            </div>
        </div>
    </div>

    <div class="full-screen-container hidden" id="roomScreen">
        <div class="room-box">
            <h2>OlÃ¡, <span id="welcomeUsername" style="color:white;"></span></h2>
            <div class="error-message" id="roomError"></div>

            <h3 style="text-align: left;">Entrar em Sala Existente</h3>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="joinRoomCode" placeholder="CÃ³digo (Ex: A1B2C3)" style="margin-bottom: 0;">
                <button class="btn-auth-primary" onclick="reqJoinRoom()" style="width: 40%; margin: 0;">Entrar</button>
            </div>

            <div style="display: flex; align-items: center; margin: 20px 0; color: #555;">
                <hr style="flex: 1; border-color: #333;"> <span style="padding: 0 10px;">OU</span> <hr style="flex: 1; border-color: #333;">
            </div>

            <h3 style="text-align: left;">Criar Nova Sala</h3>
            <input type="text" id="newRoomName" placeholder="Nome da Sala (Ex: Campanha RPG)">
            <button class="btn-auth-secondary" onclick="reqCreateRoom()">Criar Sala</button>

            <div id="newRoomCodeDisplay" class="hidden">
                <p style="color: #aaa; margin-top: 15px;">Sala criada com sucesso!</p>
                <div id="roomCodeDisplay">------</div>
                <button class="btn-auth-secondary" onclick="reqJoinRoom(document.getElementById('roomCodeDisplay').innerText)">Entrar Agora</button>
            </div>
        </div>
    </div>

    <div class="main-container hidden" id="gameScreen">
        <header>
            <h1>RP Chat</h1>
            <div class="room-info"><span id="currentRoomName">Carregando...</span> <span style="margin: 0 10px;">|</span> CÃ³digo: <strong id="currentRoomCodeDisplay" style="color: var(--accent); user-select: text;">...</strong></div>
        </header>
        <div class="grid-wrapper"><div class="grid-container" id="charGrid"></div></div>
        
        <footer>
            <span style="color:#888; font-size:0.8rem; text-transform: uppercase; letter-spacing: 1px;">Identidade:</span>
            <button class="p-btn p1-btn active" onclick="setIdentity(1)">Jogador 1</button>
            <button class="p-btn p2-btn" onclick="setIdentity(2)">Jogador 2</button>
        </footer>
    </div>

    <div class="chat-container hidden" id="chatScreen">
        <div class="chat-header">Chat do Jogo</div>
        <div class="chat-messages" id="chatBox"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Digite sua fala..." onkeypress="handleEnter(event)">
            <button id="sendBtn" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <div class="modal-overlay" id="actionModal">
        <div class="modal">
            <h2 id="modalName">...</h2>
            <img id="modalImg" class="avatar" style="width: 100px; height: 100px; margin: 0 auto 20px auto; display: block;">

            <button class="action-btn btn-primary" id="btnAssumir">Assumir Posse</button>
            <button class="action-btn btn-cancel" id="btnDeixar" onclick="reqLeave()" style="border-color: var(--p1); color: var(--p1);">Deixar Posse</button>
            
            <hr style="margin: 20px 0; border-color: #333;">

            <button class="action-btn btn-danger" id="btnExcluir" onclick="reqDelete()">Excluir Personagem</button>
            <button class="action-btn btn-cancel" onclick="closeModals()" style="margin-top: 10px;">Fechar</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <h2>Novo Personagem</h2>
            <input type="text" id="newName" placeholder="Nome do Personagem" required>
            
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="previewFile()">
                <p id="fileNameDisplay" style="margin: 0;">Clique ou arraste uma foto</p>
            </div>
            
            <img id="imgPreview" src="" style="display:none; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px auto; object-fit: cover; border: 2px solid #555;">

            <button class="action-btn btn-primary" onclick="reqCreate()">Criar Personagem</button>
            <button class="action-btn btn-cancel" onclick="closeModals()">Cancelar</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- SEU CÃ“DIGO JAVASCRIPT ---
        let socket = null; 
        let characters = [];
        let myId = 1; 
        let selectedCharId = null;
        let tempImgUrl = ''; 

        let authMode = 'login'; 
        let currentUserId = localStorage.getItem('userId') || null;
        let currentToken = localStorage.getItem('token') || null;
        let currentRoomId = null; 
        let currentRoomCode = null;

        // âœ… CORREÃ‡ÃƒO 1: setScreen mais robusto
        function setScreen(screenId) {
            try {
                // 1. Oculta todas as telas
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('roomScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('chatScreen').classList.add('hidden');

                // 2. Exibe a tela correta (ou o par de telas para 'game')
                if (screenId === 'game') {
                    document.getElementById('gameScreen').classList.remove('hidden');
                    document.getElementById('chatScreen').classList.remove('hidden');
                } else {
                    const targetScreen = document.getElementById(screenId + 'Screen');
                    if (targetScreen) {
                        targetScreen.classList.remove('hidden');
                    } else {
                        // 3. Fallback: Se a tela nÃ£o existir, loga o erro e cai no auth
                        console.error("Erro: Tela de destino nÃ£o encontrada:", screenId);
                        if (screenId !== 'auth') setScreen('auth'); 
                    }
                }
            } catch (error) {
                // 4. Fallback de seguranÃ§a: Se algo falhar aqui, garanta que a tela de login apareÃ§a
                console.error("Erro crÃ­tico em setScreen:", error);
                document.getElementById('authScreen').classList.remove('hidden');
            }
        }

        // âœ… CORREÃ‡ÃƒO 2: checkAuthState blindado
        function checkAuthState() {
            try {
                if (currentToken && currentUserId) {
                    const username = localStorage.getItem('username') || 'UsuÃ¡rio';
                    const welcomeMsg = document.getElementById('welcomeUsername');
                    if (welcomeMsg) welcomeMsg.innerText = username;
                    
                    setScreen('room');
                } else {
                    setScreen('auth');
                }
            } catch (error) {
                // Em caso de erro (ex: dados corrompidos no localStorage), limpa e forÃ§a login
                console.error("Erro ao verificar autenticaÃ§Ã£o. ForÃ§ando login:", error);
                localStorage.clear(); 
                currentUserId = null;
                currentToken = null;
                setScreen('auth');
            }
        }
        
        // Pequeno atraso para garantir que todos os elementos HTML foram carregados
        window.onload = () => {
            setTimeout(checkAuthState, 100); 
        };

        // Auth
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('authTitle').innerText = authMode === 'login' ? 'Login' : 'Criar Conta';
            document.getElementById('authSubmitBtn').innerText = authMode === 'login' ? 'Entrar' : 'Cadastrar';
            document.getElementById('authToggleText').innerText = authMode === 'login' ? 'NÃ£o tem uma conta?' : 'JÃ¡ tem uma conta?';
            document.getElementById('toggleAuth').innerText = authMode === 'login' ? 'Cadastrar-se' : 'Fazer Login';
            document.getElementById('authError').innerText = '';
        }

        async function handleAuth() {
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            const errorDisplay = document.getElementById('authError');
            errorDisplay.innerText = '';

            if (!username || !password) return errorDisplay.innerText = 'Preencha todos os campos.';

            const endpoint = authMode === 'login' ? '/api/users/login' : '/api/users/register';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (!response.ok) throw new Error(data.message || 'Erro.');

                currentUserId = data._id;
                currentToken = data.token;
                localStorage.setItem('userId', data._id);
                localStorage.setItem('token', data.token);
                localStorage.setItem('username', data.username);
                
                document.getElementById('welcomeUsername').innerText = data.username;
                setScreen('room');
            } catch (error) {
                errorDisplay.innerText = error.message;
            }
        }

        // Salas
        async function reqCreateRoom() {
            const roomName = document.getElementById('newRoomName').value.trim();
            const errorDisplay = document.getElementById('roomError');
            errorDisplay.innerText = '';

            if (!roomName) return errorDisplay.innerText = 'DÃª um nome Ã  sua sala.';
            
            try {
                const response = await fetch('/api/rooms/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
                    body: JSON.stringify({ roomName, ownerId: currentUserId })
                });
                const data = await response.json();

                if (!response.ok) throw new Error(data.message || 'Erro.');

                document.getElementById('roomCodeDisplay').innerText = data.roomCode;
                document.getElementById('newRoomCodeDisplay').classList.remove('hidden');
                document.getElementById('newRoomName').value = '';
            } catch (error) {
                errorDisplay.innerText = error.message;
            }
        }

        function reqJoinRoom(code = null) {
            const roomCode = code || document.getElementById('joinRoomCode').value.trim().toUpperCase();
            const errorDisplay = document.getElementById('roomError');
            errorDisplay.innerText = '';

            if (!roomCode) return errorDisplay.innerText = 'Insira um cÃ³digo.';

            currentRoomCode = roomCode;
            document.getElementById('charGrid').innerHTML = ''; 
            initializeSocketConnection(roomCode);
            
        }

        // Socket
        function initializeSocketConnection(roomCode) {
            if (socket) socket.disconnect(); 
            socket = io(); 

            socket.on('connect', () => { 
                socket.emit('join_room', { roomCode: roomCode, playerId: myId }); 
            });

            socket.on('room_joined', (data) => {
                currentRoomId = data.roomId;
                document.getElementById('currentRoomName').innerText = data.roomName;
                document.getElementById('currentRoomCodeDisplay').innerText = data.roomCode;
                setIdentity(data.playerId); 
                document.getElementById('chatBox').innerHTML = ''; 
                setScreen('game'); 
            });

            socket.on('room_error', (message) => {
                alert(message);
                setScreen('room');
            });
            
            socket.on('update_list', (data) => {
                characters = data;
                renderGrid(data);
            });

            socket.on('chat_history', (messages) => {
                const box = document.getElementById('chatBox');
                box.innerHTML = '';
                messages.forEach(msg => addMessageToUI(msg));
                scrollToBottom();
            });

            socket.on('receive_message', (msg) => {
                addMessageToUI(msg);
                scrollToBottom();
            });
        }

        // Game Logic
        function setIdentity(id) {
            myId = id;
            document.querySelector('.p1-btn').classList.toggle('active', id===1);
            document.querySelector('.p2-btn').classList.toggle('active', id===2);
            if(selectedCharId) openActionModal(selectedCharId);
            
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !socket) return; 
            socket.emit('send_message', { playerId: myId, text: text });
            input.value = '';
        }

        async function addMessageToUI(msg) {
            const box = document.getElementById('chatBox');
            const wrapper = document.createElement('div');
            const messageDiv = document.createElement('div');
            const avatarImg = document.createElement('img');

            wrapper.className = `message-wrapper player-${msg.playerId} msg-p${msg.playerId}`; 
            messageDiv.className = `message`;

            let charImg = '';
            const characterAtMessageTime = characters.find(c => c.name === msg.senderName);
            
            if (characterAtMessageTime) {
                charImg = characterAtMessageTime.img;
            } else if (msg.senderName.startsWith('Jogador')) {
                charImg = msg.playerId === 1 
                    ? 'https://via.placeholder.com/40/ff4d4d/ffffff?text=J1' 
                    : 'https://via.placeholder.com/40/2ecc71/ffffff?text=J2';
            } else {
                charImg = `https://via.placeholder.com/40/555555/ffffff?text=${msg.senderName.charAt(0)}`;
            }

            avatarImg.src = charImg;
            avatarImg.className = 'msg-avatar';

            messageDiv.innerHTML = `
                <span class="msg-sender">${msg.senderName}</span>
                <span class="msg-text">${msg.text}</span>
            `;
            
            if (msg.playerId === 1) {
                wrapper.appendChild(avatarImg);
                wrapper.appendChild(messageDiv);
            } else {
                wrapper.appendChild(messageDiv);
                wrapper.appendChild(avatarImg);
            }
            box.appendChild(wrapper);
        }

        function scrollToBottom() {
            const box = document.getElementById('chatBox');
            box.scrollTop = box.scrollHeight;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        // Render (Anti-Flicker)
        function updateCharacterCard(char, cardElement = null) {
            let ownerClass = '';
            if (char.owner === 1) ownerClass = char.active ? 'active-p1' : 'owned-p1';
            else if (char.owner === 2) ownerClass = char.active ? 'active-p2' : 'owned-p2';

            if (!cardElement) {
                const div = document.createElement('div');
                div.className = `character-card ${ownerClass}`;
                div.setAttribute('data-id', char._id);
                div.onclick = () => openActionModal(char._id);
                div.innerHTML = `
                    <div class="owner-badge"></div>
                    <img src="${char.img}" class="avatar">
                    <span class="char-name">${char.name}</span>
                `;
                return div;
            } else {
                cardElement.className = `character-card ${ownerClass}`;
                return cardElement;
            }
        }

        function renderGrid(newCharacters) {
            const grid = document.getElementById('charGrid');
            const currentIds = new Set();
            
            grid.querySelectorAll('.character-card[data-id]').forEach(card => {
                const id = card.getAttribute('data-id');
                if (!newCharacters.some(c => c._id === id)) card.remove();
                else currentIds.add(id);
            });
            
            newCharacters.forEach(char => {
                let card = grid.querySelector(`.character-card[data-id="${char._id}"]`);
                if (card) updateCharacterCard(char, card);
                else {
                    card = updateCharacterCard(char);
                    const addButton = grid.querySelector('.character-card:not([data-id])');
                    if (addButton) grid.insertBefore(card, addButton);
                    else grid.appendChild(card);
                }
            });
            
            if (!grid.querySelector('.character-card:not([data-id])')) {
                const add = document.createElement('div');
                add.className = 'character-card';
                add.style.border = '2px dashed #555';
                add.innerHTML = '<span style="font-size:3rem; color:#555">+</span><span style="margin-top:5px">Novo</span>'; 
                add.onclick = () => {
                    document.getElementById('createModal').style.display = 'flex';
                    document.getElementById('newName').value = '';
                    document.getElementById('fileInput').value = '';
                    document.getElementById('fileNameDisplay').innerText = 'Clique para enviar foto';
                    document.getElementById('imgPreview').style.display = 'none';
                    tempImgUrl = '';
                };
                grid.appendChild(add);
            }
        }

        // Modais
        function openActionModal(id) {
            selectedCharId = id;
            const char = characters.find(c => c._id === id);
            if(!char) return closeModals();

            document.getElementById('modalName').innerText = char.name;
            document.getElementById('modalImg').src = char.img;

            const btnAssumir = document.getElementById('btnAssumir');
            const btnDeixar = document.getElementById('btnDeixar');
            const btnExcluir = document.getElementById('btnExcluir'); 

            btnAssumir.style.display = 'none';
            btnDeixar.style.display = 'none';
            btnExcluir.style.display = 'block';
            btnAssumir.onclick = null; 

            if (char.owner === myId) {
                btnDeixar.style.display = 'block'; 
                if (char.active) {
                    btnAssumir.style.display = 'block';
                    btnAssumir.disabled = true;
                    btnAssumir.className = 'action-btn btn-disabled';
                    btnAssumir.innerText = `Personagem Ativo`;
                } else {
                    btnAssumir.style.display = 'block';
                    btnAssumir.disabled = false;
                    btnAssumir.className = 'action-btn btn-primary';
                    btnAssumir.innerText = `Interpretar Agora`;
                    btnAssumir.onclick = () => { socket.emit('set_active', { charId: selectedCharId, playerId: myId }); closeModals(); }; 
                }
                btnExcluir.disabled = false;
                btnExcluir.className = 'action-btn btn-danger';
            } else if (char.owner === null) {
                btnAssumir.style.display = 'block';
                btnAssumir.disabled = false;
                btnAssumir.className = 'action-btn btn-primary';
                btnAssumir.innerText = `Assumir Posse (J${myId})`;
                btnAssumir.onclick = reqAssume;
                btnExcluir.disabled = false;
                btnExcluir.className = 'action-btn btn-danger';
            } else {
                btnAssumir.style.display = 'block';
                btnAssumir.disabled = true;
                btnAssumir.className = 'action-btn btn-disabled';
                btnAssumir.innerText = `Ocupado por J${char.owner}`;
                btnExcluir.disabled = true;
                btnExcluir.className = 'action-btn btn-disabled';
            }
            document.getElementById('actionModal').style.display = 'flex';
        }

        function reqAssume() { if(socket) socket.emit('claim_character', {charId:selectedCharId, playerId:myId}); closeModals(); }
        function reqLeave() { if(socket) socket.emit('release_character', {charId:selectedCharId, playerId:myId}); closeModals(); }
        
        function reqDelete() { 
            if(!socket) return;
            const charToDelete = characters.find(c => c._id === selectedCharId);
            if (charToDelete && (charToDelete.owner === myId || charToDelete.owner === null)) {
                if(confirm("Excluir personagem?")) socket.emit('delete_character', selectedCharId); 
            } else {
                alert("VocÃª nÃ£o pode excluir este personagem.");
            }
            closeModals(); 
        }

        function previewFile() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                document.getElementById('fileNameDisplay').innerText = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    let result = e.target.result;

                    //garante prefixo
                    if (!result.startsWith("data:image")) {
                        result = `data:${file.type};base64,${result}`;
                    }

                    tempImgUrl = result; 
                    document.getElementById('imgPreview').src = tempImgUrl;
                    document.getElementById('imgPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        function reqCreate() {
            if(!socket) return;
            const name = document.getElementById('newName').value.trim();
            if (!name) return alert("Nome obrigatÃ³rio.");
            const img = tempImgUrl || `https://via.placeholder.com/150/555555/ffffff?text=${name.charAt(0)}`;
            socket.emit('create_character', { name: name, img: img });
            closeModals();
        }

        function closeModals() {
            document.getElementById('actionModal').style.display='none';
            document.getElementById('createModal').style.display='none';
            selectedCharId = null;
            tempImgUrl = '';
        }
        window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) closeModals(); }

    </script>
</body>
</html>