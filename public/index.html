<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    

    <title>RP Multiplayer - Salas</title>
    <style>
/* Variáveis de Cores */
:root { 
    --bg: #1a1a1a; 
    --card: #2d2d2d; 
    --text: #ffffff; 
    --p1: #ff4d4d; 
    --p2: #2ecc71; 
    --accent: #7048e8; 
    --danger: #e74c3c; 
}

/* Reset Básico */
* { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }

/* Corpo e Fundo (desktop default) */
body { 
    background-color: var(--bg); 
    color: var(--text); 
    display: flex;              /* layout horizontal: main + chat */
    height: 100vh; 
    overflow: hidden; 
    margin: 0; 
}

/* Utility */
.hidden { display: none !important; }

/* --- TELA DE LOGIN E SALAS (Centralizadas) --- */
.full-screen-container { 
    width: 100%; 
    height: 100%; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    background-color: var(--bg); 
    position: absolute; 
    top: 0;
    left: 0;
    z-index: 10;
}

.auth-box, .room-box { 
    background: var(--card); 
    padding: 40px; 
    border-radius: 15px; 
    width: 90%; 
    max-width: 400px; 
    text-align: center; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
    border: 1px solid #333;
}

.auth-box h2, .room-box h2 { margin-bottom: 25px; color: var(--accent); }
.auth-box h3, .room-box h3 { margin: 15px 0 10px; font-size: 1rem; color: #ccc; }

input[type="text"], input[type="password"] { 
    width: 100%; 
    padding: 12px; 
    margin-bottom: 15px; 
    background: #111; 
    border: 1px solid #444; 
    color: white; 
    border-radius: 8px; 
    outline: none; 
}
input:focus { border-color: var(--accent); }

button { 
    width: 100%; 
    padding: 12px; 
    margin: 5px 0; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: bold; 
    transition: 0.2s; 
    font-size: 1rem;
}

.btn-auth-primary { background: var(--accent); color: white; }
.btn-auth-primary:hover { background: #5f3dc4; }

.btn-auth-secondary { background: #444; color: white; }
.btn-auth-secondary:hover { background: #555; }

.error-message { color: var(--danger); margin-bottom: 15px; font-size: 0.9rem; min-height: 20px; }
#toggleAuth { margin-top: 15px; font-size: 0.9rem; color: #888; cursor: pointer; text-decoration: underline; }
#roomCodeDisplay { font-size: 1.5rem; font-family: monospace; margin: 15px 0; padding: 15px; background: #000; border-radius: 8px; letter-spacing: 3px; color: var(--p2); border: 1px dashed #444; }

/* --- TELA DO JOGO (Grid e Chat) --- */

/* Main container (grid area) */
.main-container { 
    flex: 2;                       /* ocupa mais espaço que o chat no desktop */
    display: flex; 
    flex-direction: column; 
    height: 100%; 
    border-right: 1px solid #333; 
    position: relative; 
    min-width: 0;                 /* evita overflow em grids */
}

/* Chat container (coluna direita no desktop) */
.chat-container { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    background: #111; 
    min-width: 300px; 
    max-width: 450px; 
    border-left: 1px solid #333; 
    height: 100vh;
    box-sizing: border-box;
}

/* Header */
header { padding: 20px; text-align: center; background: rgba(0,0,0,0.2); border-bottom: 1px solid #333; }
h1 { font-weight: 300; letter-spacing: 1px; font-size: 1.5rem; margin: 0; }
.room-info { font-size: 0.9rem; color: #888; margin-top: 5px; }

/* Grid area */
.grid-wrapper { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
.grid-container { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap: 20px; 
    width: 100%; 
    max-width: 1200px; 
}

/* Character card */
.character-card { 
    background: var(--card); 
    border-radius: 15px; 
    padding: 15px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    cursor: pointer; 
    transition: transform 0.2s, box-shadow 0.2s; 
    border: 2px solid transparent; 
    position: relative; 
    aspect-ratio: 3/4;
    justify-content: center;
}
.character-card:hover { transform: translateY(-5px); background: #353535; }

/* States */
.character-card.owned-p1 { border-color: rgba(255, 77, 77, 0.5); box-shadow: 0 0 10px rgba(255, 77, 77, 0.1); }
.character-card.owned-p2 { border-color: rgba(46, 204, 113, 0.5); box-shadow: 0 0 10px rgba(46, 204, 113, 0.1); }
.character-card.active-p1 { border-color: var(--p1); box-shadow: 0 0 20px var(--p1); transform: scale(1.05); z-index: 2; }
.character-card.active-p2 { border-color: var(--p2); box-shadow: 0 0 20px var(--p2); transform: scale(1.05); z-index: 2; }

.avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; background: #444; border: 2px solid #555; }
.char-name { font-weight: 600; font-size: 1rem; text-align: center; }

.owner-badge { position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; border-radius: 50%; display: none; }
.owned-p1 .owner-badge, .active-p1 .owner-badge { display: block; background: var(--p1); }
.owned-p2 .owner-badge, .active-p2 .owner-badge { display: block; background: var(--p2); }

/* Chat styles */
.chat-header { padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; font-weight: bold; text-align: center; }
.chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
.message-wrapper { display: flex; align-items: flex-end; gap: 10px; width: 100%; }
.message-wrapper.player-2 { flex-direction: row-reverse; }
.msg-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; }
.message { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 0.95rem; position: relative; line-height: 1.4; }
.msg-p1 .message { background: #3d2929; border-bottom-left-radius: 2px; border: 1px solid rgba(255, 77, 77, 0.3); color: #ffcece; }
.msg-p2 .message { background: #25382d; border-bottom-right-radius: 2px; border: 1px solid rgba(46, 204, 113, 0.3); color: #d0ffe3; }
.msg-sender { font-size: 0.75rem; font-weight: bold; display: block; margin-bottom: 4px; opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px; }
.msg-text { word-wrap: break-word; }

.chat-input-area { padding: 15px; background: #1a1a1a; display: flex; gap: 10px; border-top: 1px solid #333; }
#chatInput { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #444; background: #222; color: white; outline: none; }
#chatInput:focus { border-color: var(--accent); }
#sendBtn { width: auto; padding: 0 25px; border-radius: 25px; background: var(--accent); }

/* Footer (identity buttons) */
footer { padding: 15px; background: #222; display: flex; justify-content: center; gap: 20px; align-items: center; border-top: 1px solid #333; }
.p-btn { width: auto; padding: 8px 20px; border-radius: 20px; opacity: 0.4; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
.p-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 10px rgba(0,0,0,0.5); }
.p1-btn.active { background: var(--p1); border: 1px solid var(--p1); }
.p2-btn.active { background: var(--p2); border: 1px solid var(--p2); }

/* Modais */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
.modal { background: var(--card); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.file-upload-area { border: 2px dashed #444; padding: 30px; margin-bottom: 20px; cursor: pointer; color: #888; border-radius: 10px; transition: 0.2s; }
.file-upload-area:hover { border-color: var(--accent); color: white; background: rgba(255,255,255,0.05); }
.action-btn { width: 100%; padding: 12px; margin-top: 10px; font-size: 1rem; }
.btn-primary { background: var(--accent); color: white; }
.btn-cancel { background: transparent; color: #888; border: 1px solid #444; }
.btn-cancel:hover { color: white; border-color: white; }
.btn-danger { color: var(--danger); border: 1px solid var(--danger); background: transparent; }
.btn-danger:hover { background: var(--danger); color: white; }
.btn-disabled { opacity: 0.5; cursor: not-allowed; background: #444; color: #aaa; }

/* ================= RESPONSIVIDADE ================= */

/* ================= MOBILE: GRID 3x3 FIXO + SCROLL HORIZONTAL ================= */

@media (max-width: 768px) {

    /* Corrige o empilhamento geral */
    body {
        display: block;
        height: 100%;
        overflow: hidden;
    }

    /* Área superior: grid */
    .main-container { 
        width: 100%;
        height: 55vh;
        border-right: none;
        border-bottom: 1px solid #333;
        overflow: hidden;
    }

    /* Wrapper agora vira CARROSSEL */
    .grid-wrapper {
        padding: 12px;
        overflow-x: auto;           /* scroll lateral */
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        display: flex;              /* deixa o grid lado a lado */
    }

    /* GRID vira um bloco fixo 3x3 */
    .grid-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 colunas */
        grid-template-rows: repeat(3, auto);   /* 3 linhas */
        gap: 12px;
        min-width: 100%;             /* ocupa toda a tela */
        max-width: 100%;
        scroll-snap-align: start;
        padding-bottom: 10px;
    }

    /* Evita que cards “quebrem” visualmente */
    .character-card {
        min-width: unset;
        width: 100%;
    }

    /* CHAT continua embaixo */
    .chat-container {
        width: 100%;
        height: 45vh;
        border-left: none;
        border-top: 1px solid #333;
    }

    .chat-messages {
        padding: 12px;
        height: calc(45vh - 80px);
    }

    @supports (height: 100dvh) {
        .main-container { height: 55dvh; }
        .chat-container { height: 45dvh; }
        .chat-messages { height: calc(45dvh - 80px); }
    }
}


/* Tablets: semelhante ao mobile mas com mais espaço */
@media (min-width: 769px) and (max-width: 1024px) {
    .main-container { width: 100%; height: 60vh; border-right: none; border-bottom: 1px solid #333; }
    .chat-container { width: 100%; height: 40vh; border-left: none; }
    .grid-container { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 14px; }
}

/* Desktop large */
@media (min-width: 1200px) {
    .grid-container { max-width: 1200px; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    .chat-container { max-width: 450px; }
}

/* Ensure scrollbars behave */
.grid-wrapper::-webkit-scrollbar, .chat-messages::-webkit-scrollbar { width: 8px; height: 8px; }
.grid-wrapper::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.06); border-radius: 4px; }

</style>


</head>
<body>

    <div class="full-screen-container" id="authScreen">
        <div class="auth-box">
            <h2 id="authTitle">Login</h2>
            <div class="error-message" id="authError"></div>

            <input type="text" id="authUsername" placeholder="Nome de Usuário">
            <input type="password" id="authPassword" placeholder="Senha">

            <button class="btn-auth-primary" id="authSubmitBtn" onclick="handleAuth()">Entrar</button>
            
            <div style="margin-top: 15px; font-size: 0.9rem; color: #aaa;">
                <span id="authToggleText">Não tem uma conta?</span>
                <span id="toggleAuth" onclick="toggleAuthMode()" style="color: var(--accent); cursor: pointer; font-weight: bold; margin-left: 5px;">Cadastrar-se</span>
            </div>
        </div>
    </div>

    <div class="full-screen-container hidden" id="roomScreen">
        <div class="room-box">
            <h2>Olá, <span id="welcomeUsername" style="color:white;"></span></h2>
            <div class="error-message" id="roomError"></div>

            <h3 style="text-align: left;">Entrar em Sala Existente</h3>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="joinRoomCode" placeholder="Código (Ex: A1B2C3)" style="margin-bottom: 0;">
                <button class="btn-auth-primary" onclick="reqJoinRoom()" style="width: 40%; margin: 0;">Entrar</button>
            </div>

            <div style="display: flex; align-items: center; margin: 20px 0; color: #555;">
                <hr style="flex: 1; border-color: #333;"> <span style="padding: 0 10px;">OU</span> <hr style="flex: 1; border-color: #333;">
            </div>

            <h3 style="text-align: left;">Criar Nova Sala</h3>
            <input type="text" id="newRoomName" placeholder="Nome da Sala (Ex: Campanha RPG)">
            <button class="btn-auth-secondary" onclick="reqCreateRoom()">Criar Sala</button>

            <div id="newRoomCodeDisplay" class="hidden">
                <p style="color: #aaa; margin-top: 15px;">Sala criada com sucesso!</p>
                <div id="roomCodeDisplay">------</div>
                <button class="btn-auth-secondary" onclick="reqJoinRoom(document.getElementById('roomCodeDisplay').innerText)">Entrar Agora</button>
            </div>
        </div>
    </div>

    <div class="main-container hidden" id="gameScreen">
        <header>
            <h1>RP Chat</h1>
            <div class="room-info"><span id="currentRoomName">Carregando...</span> <span style="margin: 0 10px;">|</span> Código: <strong id="currentRoomCodeDisplay" style="color: var(--accent); user-select: text;">...</strong></div>
        </header>
        <div class="grid-wrapper"><div class="grid-container" id="charGrid"></div></div>
        
        <footer>
            <span style="color:#888; font-size:0.8rem; text-transform: uppercase; letter-spacing: 1px;">Identidade:</span>
            <button class="p-btn p1-btn active" onclick="setIdentity(1)">Jogador 1</button>
            <button class="p-btn p2-btn" onclick="setIdentity(2)">Jogador 2</button>
        </footer>
    </div>

    <div class="chat-container hidden" id="chatScreen">
        <div class="chat-header">Chat do Jogo</div>
        <div class="chat-messages" id="chatBox"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Digite sua fala..." onkeypress="handleEnter(event)">
            <button id="sendBtn" onclick="sendMessage()">Enviar</button>
        </div>
    </div>

    <div class="modal-overlay" id="actionModal">
        <div class="modal">
            <h2 id="modalName">...</h2>
            <img id="modalImg" class="avatar" style="width: 100px; height: 100px; margin: 0 auto 20px auto; display: block;">

            <button class="action-btn btn-primary" id="btnAssumir">Assumir Posse</button>
            <button class="action-btn btn-cancel" id="btnDeixar" onclick="reqLeave()" style="border-color: var(--p1); color: var(--p1);">Deixar Posse</button>
            
            <hr style="margin: 20px 0; border-color: #333;">

            <button class="action-btn btn-danger" id="btnExcluir" onclick="reqDelete()">Excluir Personagem</button>
            <button class="action-btn btn-cancel" onclick="closeModals()" style="margin-top: 10px;">Fechar</button>
        </div>
    </div>
    
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <h2>Novo Personagem</h2>
            <input type="text" id="newName" placeholder="Nome do Personagem" required>
            
            <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="previewFile()">
                <p id="fileNameDisplay" style="margin: 0;">Clique ou arraste uma foto</p>
            </div>
            
            <img id="imgPreview" src="" style="display:none; width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px auto; object-fit: cover; border: 2px solid #555;">

            <button class="action-btn btn-primary" onclick="reqCreate()">Criar Personagem</button>
            <button class="action-btn btn-cancel" onclick="closeModals()">Cancelar</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- SEU CÓDIGO JAVASCRIPT ---
        let socket = null; 
        let characters = [];
        let myId = 1; 
        let selectedCharId = null;
        let tempImgUrl = ''; 

        let authMode = 'login'; 
        let currentUserId = localStorage.getItem('userId') || null;
        let currentToken = localStorage.getItem('token') || null;
        let currentRoomId = null; 
        let currentRoomCode = null;

        // ✅ CORREÇÃO 1: setScreen mais robusto
        function setScreen(screenId) {
            try {
                // 1. Oculta todas as telas
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('roomScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('chatScreen').classList.add('hidden');

                // 2. Exibe a tela correta (ou o par de telas para 'game')
                if (screenId === 'game') {
                    document.getElementById('gameScreen').classList.remove('hidden');
                    document.getElementById('chatScreen').classList.remove('hidden');
                } else {
                    const targetScreen = document.getElementById(screenId + 'Screen');
                    if (targetScreen) {
                        targetScreen.classList.remove('hidden');
                    } else {
                        // 3. Fallback: Se a tela não existir, loga o erro e cai no auth
                        console.error("Erro: Tela de destino não encontrada:", screenId);
                        if (screenId !== 'auth') setScreen('auth'); 
                    }
                }
            } catch (error) {
                // 4. Fallback de segurança: Se algo falhar aqui, garanta que a tela de login apareça
                console.error("Erro crítico em setScreen:", error);
                document.getElementById('authScreen').classList.remove('hidden');
            }
        }

        // ✅ CORREÇÃO 2: checkAuthState blindado
        function checkAuthState() {
            try {
                if (currentToken && currentUserId) {
                    const username = localStorage.getItem('username') || 'Usuário';
                    const welcomeMsg = document.getElementById('welcomeUsername');
                    if (welcomeMsg) welcomeMsg.innerText = username;
                    
                    setScreen('room');
                } else {
                    setScreen('auth');
                }
            } catch (error) {
                // Em caso de erro (ex: dados corrompidos no localStorage), limpa e força login
                console.error("Erro ao verificar autenticação. Forçando login:", error);
                localStorage.clear(); 
                currentUserId = null;
                currentToken = null;
                setScreen('auth');
            }
        }
        
        // Pequeno atraso para garantir que todos os elementos HTML foram carregados
        window.onload = () => {
            setTimeout(checkAuthState, 100); 
        };

        // Auth
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('authTitle').innerText = authMode === 'login' ? 'Login' : 'Criar Conta';
            document.getElementById('authSubmitBtn').innerText = authMode === 'login' ? 'Entrar' : 'Cadastrar';
            document.getElementById('authToggleText').innerText = authMode === 'login' ? 'Não tem uma conta?' : 'Já tem uma conta?';
            document.getElementById('toggleAuth').innerText = authMode === 'login' ? 'Cadastrar-se' : 'Fazer Login';
            document.getElementById('authError').innerText = '';
        }

        async function handleAuth() {
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            const errorDisplay = document.getElementById('authError');
            errorDisplay.innerText = '';

            if (!username || !password) return errorDisplay.innerText = 'Preencha todos os campos.';

            const endpoint = authMode === 'login' ? '/api/users/login' : '/api/users/register';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (!response.ok) throw new Error(data.message || 'Erro.');

                currentUserId = data._id;
                currentToken = data.token;
                localStorage.setItem('userId', data._id);
                localStorage.setItem('token', data.token);
                localStorage.setItem('username', data.username);
                
                document.getElementById('welcomeUsername').innerText = data.username;
                setScreen('room');
            } catch (error) {
                errorDisplay.innerText = error.message;
            }
        }

        // Salas
        async function reqCreateRoom() {
            const roomName = document.getElementById('newRoomName').value.trim();
            const errorDisplay = document.getElementById('roomError');
            errorDisplay.innerText = '';

            if (!roomName) return errorDisplay.innerText = 'Dê um nome à sua sala.';
            
            try {
                const response = await fetch('/api/rooms/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
                    body: JSON.stringify({ roomName, ownerId: currentUserId })
                });
                const data = await response.json();

                if (!response.ok) throw new Error(data.message || 'Erro.');

                document.getElementById('roomCodeDisplay').innerText = data.roomCode;
                document.getElementById('newRoomCodeDisplay').classList.remove('hidden');
                document.getElementById('newRoomName').value = '';
            } catch (error) {
                errorDisplay.innerText = error.message;
            }
        }

        function reqJoinRoom(code = null) {
            const roomCode = code || document.getElementById('joinRoomCode').value.trim().toUpperCase();
            const errorDisplay = document.getElementById('roomError');
            errorDisplay.innerText = '';

            if (!roomCode) return errorDisplay.innerText = 'Insira um código.';

            currentRoomCode = roomCode;
            document.getElementById('charGrid').innerHTML = ''; 
            initializeSocketConnection(roomCode);
            
        }

        // Socket
        function initializeSocketConnection(roomCode) {
            if (socket) socket.disconnect(); 
            socket = io(); 

            socket.on('connect', () => { 
                socket.emit('join_room', { roomCode: roomCode, playerId: myId }); 
            });

            socket.on('room_joined', (data) => {
                currentRoomId = data.roomId;
                document.getElementById('currentRoomName').innerText = data.roomName;
                document.getElementById('currentRoomCodeDisplay').innerText = data.roomCode;
                setIdentity(data.playerId); 
                document.getElementById('chatBox').innerHTML = ''; 
                setScreen('game'); 
            });

            socket.on('room_error', (message) => {
                alert(message);
                setScreen('room');
            });
            
            socket.on('update_list', (data) => {
                characters = data;
                renderGrid(data);
            });

            socket.on('chat_history', (messages) => {
                const box = document.getElementById('chatBox');
                box.innerHTML = '';
                messages.forEach(msg => addMessageToUI(msg));
                scrollToBottom();
            });

            socket.on('receive_message', (msg) => {
                addMessageToUI(msg);
                scrollToBottom();
            });
        }

        // Game Logic
        function setIdentity(id) {
            myId = id;
            document.querySelector('.p1-btn').classList.toggle('active', id===1);
            document.querySelector('.p2-btn').classList.toggle('active', id===2);
            if(selectedCharId) openActionModal(selectedCharId);
            
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !socket) return; 
            socket.emit('send_message', { playerId: myId, text: text });
            input.value = '';
        }

        async function addMessageToUI(msg) {
            const box = document.getElementById('chatBox');
            const wrapper = document.createElement('div');
            const messageDiv = document.createElement('div');
            const avatarImg = document.createElement('img');

            wrapper.className = `message-wrapper player-${msg.playerId} msg-p${msg.playerId}`; 
            messageDiv.className = `message`;

            let charImg = '';
            const characterAtMessageTime = characters.find(c => c.name === msg.senderName);
            
            if (characterAtMessageTime) {
                charImg = characterAtMessageTime.img;
            } else if (msg.senderName.startsWith('Jogador')) {
                charImg = msg.playerId === 1 
                    ? 'https://via.placeholder.com/40/ff4d4d/ffffff?text=J1' 
                    : 'https://via.placeholder.com/40/2ecc71/ffffff?text=J2';
            } else {
                charImg = `https://via.placeholder.com/40/555555/ffffff?text=${msg.senderName.charAt(0)}`;
            }

            avatarImg.src = charImg;
            avatarImg.className = 'msg-avatar';

            messageDiv.innerHTML = `
                <span class="msg-sender">${msg.senderName}</span>
                <span class="msg-text">${msg.text}</span>
            `;
            
            if (msg.playerId === 1) {
                wrapper.appendChild(avatarImg);
                wrapper.appendChild(messageDiv);
            } else {
                wrapper.appendChild(messageDiv);
                wrapper.appendChild(avatarImg);
            }
            box.appendChild(wrapper);
        }

        function scrollToBottom() {
            const box = document.getElementById('chatBox');
            box.scrollTop = box.scrollHeight;
        }

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        // Render (Anti-Flicker)
        function updateCharacterCard(char, cardElement = null) {
            let ownerClass = '';
            if (char.owner === 1) ownerClass = char.active ? 'active-p1' : 'owned-p1';
            else if (char.owner === 2) ownerClass = char.active ? 'active-p2' : 'owned-p2';

            if (!cardElement) {
                const div = document.createElement('div');
                div.className = `character-card ${ownerClass}`;
                div.setAttribute('data-id', char._id);
                div.onclick = () => openActionModal(char._id);
                div.innerHTML = `
                    <div class="owner-badge"></div>
                    <img src="${char.img}" class="avatar">
                    <span class="char-name">${char.name}</span>
                `;
                return div;
            } else {
                cardElement.className = `character-card ${ownerClass}`;
                return cardElement;
            }
        }

        function renderGrid(newCharacters) {
            const grid = document.getElementById('charGrid');
            const currentIds = new Set();
            
            grid.querySelectorAll('.character-card[data-id]').forEach(card => {
                const id = card.getAttribute('data-id');
                if (!newCharacters.some(c => c._id === id)) card.remove();
                else currentIds.add(id);
            });
            
            newCharacters.forEach(char => {
                let card = grid.querySelector(`.character-card[data-id="${char._id}"]`);
                if (card) updateCharacterCard(char, card);
                else {
                    card = updateCharacterCard(char);
                    const addButton = grid.querySelector('.character-card:not([data-id])');
                    if (addButton) grid.insertBefore(card, addButton);
                    else grid.appendChild(card);
                }
            });
            
            if (!grid.querySelector('.character-card:not([data-id])')) {
                const add = document.createElement('div');
                add.className = 'character-card';
                add.style.border = '2px dashed #555';
                add.innerHTML = '<span style="font-size:3rem; color:#555">+</span><span style="margin-top:5px">Novo</span>'; 
                add.onclick = () => {
                    document.getElementById('createModal').style.display = 'flex';
                    document.getElementById('newName').value = '';
                    document.getElementById('fileInput').value = '';
                    document.getElementById('fileNameDisplay').innerText = 'Clique para enviar foto';
                    document.getElementById('imgPreview').style.display = 'none';
                    tempImgUrl = '';
                };
                grid.appendChild(add);
            }
        }

        // Modais
        function openActionModal(id) {
            selectedCharId = id;
            const char = characters.find(c => c._id === id);
            if(!char) return closeModals();

            document.getElementById('modalName').innerText = char.name;
            document.getElementById('modalImg').src = char.img;

            const btnAssumir = document.getElementById('btnAssumir');
            const btnDeixar = document.getElementById('btnDeixar');
            const btnExcluir = document.getElementById('btnExcluir'); 

            btnAssumir.style.display = 'none';
            btnDeixar.style.display = 'none';
            btnExcluir.style.display = 'block';
            btnAssumir.onclick = null; 

            if (char.owner === myId) {
                btnDeixar.style.display = 'block'; 
                if (char.active) {
                    btnAssumir.style.display = 'block';
                    btnAssumir.disabled = true;
                    btnAssumir.className = 'action-btn btn-disabled';
                    btnAssumir.innerText = `Personagem Ativo`;
                } else {
                    btnAssumir.style.display = 'block';
                    btnAssumir.disabled = false;
                    btnAssumir.className = 'action-btn btn-primary';
                    btnAssumir.innerText = `Interpretar Agora`;
                    btnAssumir.onclick = () => { socket.emit('set_active', { charId: selectedCharId, playerId: myId }); closeModals(); }; 
                }
                btnExcluir.disabled = false;
                btnExcluir.className = 'action-btn btn-danger';
            } else if (char.owner === null) {
                btnAssumir.style.display = 'block';
                btnAssumir.disabled = false;
                btnAssumir.className = 'action-btn btn-primary';
                btnAssumir.innerText = `Assumir Posse (J${myId})`;
                btnAssumir.onclick = reqAssume;
                btnExcluir.disabled = false;
                btnExcluir.className = 'action-btn btn-danger';
            } else {
                btnAssumir.style.display = 'block';
                btnAssumir.disabled = true;
                btnAssumir.className = 'action-btn btn-disabled';
                btnAssumir.innerText = `Ocupado por J${char.owner}`;
                btnExcluir.disabled = true;
                btnExcluir.className = 'action-btn btn-disabled';
            }
            document.getElementById('actionModal').style.display = 'flex';
        }

        function reqAssume() { if(socket) socket.emit('claim_character', {charId:selectedCharId, playerId:myId}); closeModals(); }
        function reqLeave() { if(socket) socket.emit('release_character', {charId:selectedCharId, playerId:myId}); closeModals(); }
        
        function reqDelete() { 
            if(!socket) return;
            const charToDelete = characters.find(c => c._id === selectedCharId);
            if (charToDelete && (charToDelete.owner === myId || charToDelete.owner === null)) {
                if(confirm("Excluir personagem?")) socket.emit('delete_character', selectedCharId); 
            } else {
                alert("Você não pode excluir este personagem.");
            }
            closeModals(); 
        }

        function previewFile() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                document.getElementById('fileNameDisplay').innerText = file.name;
                const reader = new FileReader();
                reader.onload = function(e) {
                    let result = e.target.result;

                    //garante prefixo
                    if (!result.startsWith("data:image")) {
                        result = `data:${file.type};base64,${result}`;
                    }

                    tempImgUrl = result; 
                    document.getElementById('imgPreview').src = tempImgUrl;
                    document.getElementById('imgPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        function reqCreate() {
            if(!socket) return;
            const name = document.getElementById('newName').value.trim();
            if (!name) return alert("Nome obrigatório.");
            const img = tempImgUrl || `https://via.placeholder.com/150/555555/ffffff?text=${name.charAt(0)}`;
            socket.emit('create_character', { name: name, img: img });
            closeModals();
        }

        function closeModals() {
            document.getElementById('actionModal').style.display='none';
            document.getElementById('createModal').style.display='none';
            selectedCharId = null;
            tempImgUrl = '';
        }
        window.onclick = (e) => { if(e.target.classList.contains('modal-overlay')) closeModals(); }

    </script>
</body>
</html>